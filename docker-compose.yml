services:
  smart-app:
    # 使用當前目錄的 Dockerfile 來建置映像檔
    build: 
      context: .
      dockerfile: Dockerfile
    
    # 為容器命名，方便管理
    container_name: smart_fhir_app
    
    # 將主機的 8080 port 映射到容器的 8080 port
    ports:
      - "8080:8080"
    
    # 環境變數配置
    # 選項1：使用 .env 文件（推薦開發環境）
    # 複製 local.env.template 為 .env 並配置
    env_file:
      - .env  # 確保此文件存在並已配置
    
    # 選項2：直接在這裡設定環境變數（僅供參考，不建議提交敏感資訊）
    environment:
      - FLASK_ENV=development
      - TESTING=false
      # 其他環境變數請在 .env 文件中設定
    
    # 開發模式：掛載本地程式碼到容器
    # 這樣修改程式碼時無需重新建置映像檔
    volumes:
      - .:/app
      - /app/__pycache__  # 排除 Python 快取
      - /app/.pytest_cache  # 排除 pytest 快取
    
    # 健康檢查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # 重啟策略
    restart: unless-stopped
    
    # 日誌配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  default:
    name: smart_fhir_app_network
