{% extends "layout.html" %}
{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-1">{{ title }} - Patient ID: {{ patient_id }}</h2>
                        <p class="text-muted mb-0">
                            <i class="fas fa-info-circle mr-1"></i>
                            PRECISE-DAPT 出血風險評估 5-item 模型 ({{ config_version or '2.1.0' }})
                        </p>
                    </div>
                    <div>
                        <a href="{{ url_for('main_app_page') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left mr-2"></i>返回主頁
                        </a>
                    </div>
                </div>

    {% if calculation_details and calculation_details.category %}
                    <!-- Risk Category Alert -->
                    <div class="alert alert-{% if 'High' in calculation_details.category %}danger{% elif 'Moderate' in calculation_details.category %}warning{% elif 'Low' in calculation_details.category and 'Very Low' not in calculation_details.category %}info{% else %}success{% endif %} shadow-sm" role="alert">
                        <div class="d-flex align-items-center">
                            <div class="mr-3">
                                {% if 'High' in calculation_details.category %}
                                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                                {% elif 'Moderate' in calculation_details.category %}
                                    <i class="fas fa-exclamation-circle fa-2x"></i>
                                {% elif 'Low' in calculation_details.category and 'Very Low' not in calculation_details.category %}
                                    <i class="fas fa-info-circle fa-2x"></i>
                                {% else %}
                                    <i class="fas fa-check-circle fa-2x"></i>
                                {% endif %}
                            </div>
                            <div>
                                <h4 class="alert-heading mb-1">
                                    出血風險等級: 
                                    <span class="font-weight-bold text-uppercase">{{ calculation_details.category }}</span>
                                </h4>
                                <p class="mb-0">
                                    <strong>PRECISE-DAPT 分數: {{ calculation_details.score }}</strong>
                                    {% if 'High' in calculation_details.category %}
                                        - <strong>建議縮短 DAPT 持續時間 (3-6 個月)</strong>
                                    {% elif 'Moderate' in calculation_details.category %}
                                        - <strong>標準 DAPT 持續時間，但需謹慎監測</strong>
                                    {% elif 'Low' in calculation_details.category and 'Very Low' not in calculation_details.category %}
                                        - <strong>建議標準 DAPT 持續時間 (12 個月)</strong>
                                    {% else %}
                                        - <strong>極低出血風險，可考慮延長 DAPT 持續時間</strong>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Left Column: Patient Demographics and Lab Values -->
                        <div class="col-lg-6 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-user-md mr-2"></i>患者資料 & PRECISE-DAPT 參數
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr>
                                                <th class="w-40">年齡:</th>
                                                <td>
                                                    <span class="badge badge-{% if calculation_details.score_details.age_score_component > 0 %}warning{% else %}secondary{% endif %}">
                                                        {{ calculation_details.age if calculation_details.age is not none else 'Unknown' }} 歲
                                                    </span>
                                                    {% if calculation_details.score_details.age_score_component > 0 %}
                                                        <small class="text-warning ml-2">
                                                            <i class="fas fa-plus-circle"></i> {{ calculation_details.score_details.age_score_component }}分
                                                        </small>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>性別:</th>
                                                <td>
                                                    <span class="badge badge-info">
                                                        {{ calculation_details.sex.title() if calculation_details.sex else 'Unknown' }}
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>血紅蛋白 (g/dL):</th>
                                                <td>
                                                    {% if calculation_details.hb_value is not none %}
                                                        <span class="badge badge-{% if calculation_details.score_details.hemoglobin_score_component > 0 %}warning{% else %}success{% endif %}">
                                                            {{ "%.1f" | format(calculation_details.hb_value) }}
                                                        </span>
                                                        {% if calculation_details.score_details.hemoglobin_score_component > 0 %}
                                                            <small class="text-warning ml-2">
                                                                <i class="fas fa-plus-circle"></i> {{ calculation_details.score_details.hemoglobin_score_component }}分
                                                            </small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="badge badge-secondary">未測量</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>肌酐清除率 (mL/min/1.73m²):</th>
                                                <td>
                                                    {% if calculation_details.ccr_value is not none %}
                                                        <span class="badge badge-{% if calculation_details.score_details.creatinine_clearance_score_component > 0 %}warning{% else %}success{% endif %}">
                                                            {{ "%.0f" | format(calculation_details.ccr_value) }}
                                                        </span>
                                                        {% if calculation_details.score_details.creatinine_clearance_score_component > 0 %}
                                                            <small class="text-warning ml-2">
                                                                <i class="fas fa-plus-circle"></i> {{ calculation_details.score_details.creatinine_clearance_score_component }}分
                                                            </small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="badge badge-secondary">未測量</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>白血球計數 (×10⁹/L):</th>
                                                <td>
                                                    {% if calculation_details.wbc_value is not none %}
                                                        <span class="badge badge-{% if calculation_details.score_details.wbc_score_component > 0 %}warning{% else %}success{% endif %}">
                                                            {{ "%.1f" | format(calculation_details.wbc_value) }}
                                                        </span>
                                                        {% if calculation_details.score_details.wbc_score_component > 0 %}
                                                            <small class="text-warning ml-2">
                                                                <i class="fas fa-plus-circle"></i> {{ calculation_details.score_details.wbc_score_component }}分
                                                            </small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="badge badge-secondary">未測量</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>既往出血史:</th>
                                                <td>
                                                    <span class="badge badge-{% if calculation_details.bleeding_history %}danger{% else %}success{% endif %}">
                                                        {% if calculation_details.bleeding_history %}有{% else %}無{% endif %}
                                                    </span>
                                                    {% if calculation_details.score_details.bleeding_history_score_component > 0 %}
                                                        <small class="text-danger ml-2">
                                                            <i class="fas fa-plus-circle"></i> {{ calculation_details.score_details.bleeding_history_score_component }}分
                                                        </small>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: PRECISE-DAPT Score Summary -->
                        <div class="col-lg-6 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-calculator mr-2"></i>PRECISE-DAPT 分數摘要
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr>
                                                <th class="w-60">年齡分數:</th>
                                                <td class="text-right">
                                                    <span class="badge badge-{% if calculation_details.score_details.age_score_component > 0 %}warning{% else %}light{% endif %} badge-lg">
                                                        {{ calculation_details.score_details.age_score_component }} 分
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>血紅蛋白分數:</th>
                                                <td class="text-right">
                                                    <span class="badge badge-{% if calculation_details.score_details.hemoglobin_score_component > 0 %}warning{% else %}light{% endif %} badge-lg">
                                                        {{ calculation_details.score_details.hemoglobin_score_component }} 分
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>肌酐清除率分數:</th>
                                                <td class="text-right">
                                                    <span class="badge badge-{% if calculation_details.score_details.creatinine_clearance_score_component > 0 %}warning{% else %}light{% endif %} badge-lg">
                                                        {{ calculation_details.score_details.creatinine_clearance_score_component }} 分
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>白血球計數分數:</th>
                                                <td class="text-right">
                                                    <span class="badge badge-{% if calculation_details.score_details.wbc_score_component > 0 %}warning{% else %}light{% endif %} badge-lg">
                                                        {{ calculation_details.score_details.wbc_score_component }} 分
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>既往出血史分數:</th>
                                                <td class="text-right">
                                                    <span class="badge badge-{% if calculation_details.score_details.bleeding_history_score_component > 0 %}danger{% else %}light{% endif %} badge-lg">
                                                        {{ calculation_details.score_details.bleeding_history_score_component }} 分
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr class="border-top">
                                                <th class="h5">總分:</th>
                                                <td class="text-right">
                                                    <span class="badge badge-{% if 'High' in calculation_details.category %}danger{% elif 'Moderate' in calculation_details.category %}warning{% elif 'Low' in calculation_details.category and 'Very Low' not in calculation_details.category %}info{% else %}success{% endif %} badge-lg h5 mb-0">
                                                        {{ calculation_details.score }} 分
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Risk Components Section -->
                    {% if risk_components %}
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-list-ul mr-2"></i>
                                    詳細 PRECISE-DAPT 組件 ({{ risk_components|length }})
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>參數</th>
                                                <th>數值</th>
                                                <th>分數</th>
                                                <th>日期</th>
                                                <th>說明</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for component in risk_components %}
                                                <tr class="{% if component.score > 0 %}table-warning{% endif %}">
                                                    <td>
                                                        <strong>{{ component.parameter }}</strong>
                                                    </td>
                                                    <td>{{ component.value }}</td>
                                                    <td>
                                                        <span class="badge badge-{% if component.score >= 15 %}danger{% elif component.score >= 5 %}warning{% elif component.score > 0 %}info{% else %}secondary{% endif %}">
                                                            {{ component.score }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted">{{ component.date }}</small>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted">{{ component.description }}</small>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- High Risk Guideline Section -->
                    {% if 'High' in calculation_details.category %}
                        <div class="card shadow-sm mb-4 border-danger">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    高出血風險 DAPT 管理指引
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning">
                                    <h6><i class="fas fa-info-circle mr-2"></i>臨床建議 (PRECISE-DAPT ≥25):</h6>
                                    <ul class="mb-0">
                                        <li>考慮縮短 DAPT 持續時間 (3-6 個月)</li>
                                        <li>密切監測出血事件</li>
                                        <li>評估是否使用質子泵抑制劑</li>
                                        <li>定期檢查血紅蛋白和腎功能</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% elif 'Moderate' in calculation_details.category %}
                        <div class="card shadow-sm mb-4 border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="fas fa-exclamation-circle mr-2"></i>
                                    中等出血風險 DAPT 管理建議
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle mr-2"></i>臨床建議 (PRECISE-DAPT 16-24):</h6>
                                    <ul class="mb-0">
                                        <li>標準 DAPT 持續時間 (12 個月)</li>
                                        <li>定期監測出血風險因素</li>
                                        <li>考慮個人化治療策略</li>
                                        <li>必要時諮詢心臟科醫師</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% elif 'Low' in calculation_details.category and 'Very Low' not in calculation_details.category %}
                        <div class="card shadow-sm mb-4 border-info">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    低出血風險 DAPT 管理建議
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-success">
                                    <h6><i class="fas fa-check-circle mr-2"></i>臨床建議 (PRECISE-DAPT 8-15):</h6>
                                    <ul class="mb-0">
                                        <li>標準 DAPT 持續時間 (12 個月) 建議</li>
                                        <li>常規監測即可</li>
                                        <li>根據缺血風險評估延長治療</li>
                                        <li>遵循指引建議的抗血小板治療</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="card shadow-sm mb-4 border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    極低出血風險 DAPT 管理建議
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-success">
                                    <h6><i class="fas fa-thumbs-up mr-2"></i>臨床建議 (PRECISE-DAPT 0-7):</h6>
                                    <ul class="mb-0">
                                        <li>極低出血風險，可考慮延長 DAPT</li>
                                        <li>標準或延長 DAPT 持續時間皆可</li>
                                        <li>根據缺血風險評估治療策略</li>
                                        <li>可考慮長期雙重抗血小板治療</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Technical Details (Collapsible) -->
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <button class="btn btn-link btn-block text-left" type="button" 
                                    data-toggle="collapse" data-target="#technicalDetails" 
                                    aria-expanded="false" aria-controls="technicalDetails">
                                <i class="fas fa-cogs mr-2"></i>
                                技術計算詳情
                                <i class="fas fa-chevron-down float-right"></i>
                            </button>
                        </div>
                        <div id="technicalDetails" class="collapse">
                            <div class="card-body">
                                <h6>配置版本: {{ config_version or '1.2.0' }}</h6>
                                <h6>評分系統: PRECISE-DAPT 2017</h6>
                                
                                <h6 class="mt-4">分數詳情:</h6>
                                <pre class="bg-light p-3" style="max-height: 300px; overflow-y: auto;">{{ calculation_details.score_details | tojson(indent=2) }}</pre>
                                
                                {% if risk_components %}
                                <h6 class="mt-4">完整組件清單:</h6>
                                <pre class="bg-light p-3" style="max-height: 300px; overflow-y: auto;">{{ risk_components | tojson(indent=2) }}</pre>
                                {% endif %}
                            </div>
                        </div>
                    </div>

    {% else %}
                    <!-- Error State -->
                    <div class="alert alert-danger shadow-sm" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fa-2x mr-3"></i>
                            <div>
                                <h4 class="alert-heading">無法計算或顯示 PRECISE-DAPT 分數</h4>
                                <p class="mb-0">請檢查數據是否完整或稍後再試。</p>
                            </div>
                        </div>
                    </div>
    {% endif %}

                <!-- Action Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <div>
                        <a href="{{ url_for('main_app_page') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left mr-2"></i>返回主應用程式
                        </a>
                    </div>
                    <div>
                        <a href="{{ url_for('main_page') }}" class="btn btn-outline-info">
                            <i class="fas fa-tachometer-alt mr-2"></i>簡化版界面
                        </a>
                        <a href="{{ url_for('launch_cerner_sandbox') }}" class="btn btn-outline-primary ml-2">
                            <i class="fas fa-vial mr-2"></i>Cerner 沙盒測試
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
// Add some interactive features for PRECISE-DAPT
document.addEventListener('DOMContentLoaded', function() {
    // Highlight components with scores
    const scoredRows = document.querySelectorAll('tr.table-warning');
    scoredRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#fff3cd';
            this.style.transform = 'scale(1.02)';
            this.style.transition = 'all 0.2s';
        });
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
            this.style.transform = '';
        });
    });
    
    // Add tooltips for score ranges
    const scoreElements = document.querySelectorAll('.badge');
    scoreElements.forEach(badge => {
        if (badge.textContent.includes('分')) {
            badge.setAttribute('title', 'PRECISE-DAPT 評分系統: 0-100分');
        }
    });
});
</script>
{% endblock %}

<!-- Custom CSS for Enhanced PRECISE-DAPT Styling -->
<style>
    /* Enhanced styling for high bleeding risk alert */
    .alert-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
        border: 2px solid #bd2130 !important;
        color: white !important;
        font-weight: 500;
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3) !important;
    }
    
    .alert-danger .alert-heading {
        color: white !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    .alert-danger .fas {
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    /* Enhanced warning styling for moderate risk */
    .alert-warning {
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%) !important;
        border: 2px solid #d39e00 !important;
        color: #212529 !important;
        font-weight: 500;
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3) !important;
    }
    
    /* Enhanced info styling for low risk */
    .alert-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
        border: 2px solid #117a8b !important;
        color: white !important;
        font-weight: 500;
        box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3) !important;
    }
    
    .alert-info .alert-heading {
        color: white !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    /* Enhanced success styling for very low risk */
    .alert-success {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%) !important;
        border: 2px solid #1c7430 !important;
        color: white !important;
        font-weight: 500;
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3) !important;
    }
    
    .alert-success .alert-heading {
        color: white !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    /* Badge styling enhancements */
    .badge-lg {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }
    
    .badge-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }
    
    .badge-warning {
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%) !important;
        box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
    }
    
    .badge-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
        box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
    }
    
    .badge-success {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%) !important;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }
    
    /* Table enhancements */
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .table-warning {
        background-color: #fff3cd !important;
    }
    
    /* PRECISE-DAPT specific styling */
    .card-header.bg-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
    }
    
    .card-header.bg-success {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%) !important;
    }
    
    .card-header.bg-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
    }
</style>
