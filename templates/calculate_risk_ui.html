{% extends "layout.html" %}
{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-1">{{ title }} - Patient ID: {{ patient_id }}</h2>
                        <p class="text-muted mb-0">
                            <i class="fas fa-info-circle mr-1"></i>
                            PRECISE-DAPT Bleeding Risk Assessment 5-item Model ({{ config_version or '2.1.0' }})
                        </p>
                    </div>
                    <div>
                        <a href="{{ url_for('main_app_page') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Main
                        </a>
                    </div>
                </div>

    {% if calculation_details and calculation_details.category %}
                    <!-- Risk Category Alert -->
                    <div class="alert alert-{% if 'High' in calculation_details.category %}danger{% elif 'Moderate' in calculation_details.category %}warning{% elif 'Low' in calculation_details.category and 'Very Low' not in calculation_details.category %}info{% else %}success{% endif %} shadow-sm" role="alert">
                        <div class="d-flex align-items-center">
                            <div class="mr-3">
                                {% if 'High' in calculation_details.category %}
                                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                                {% elif 'Moderate' in calculation_details.category %}
                                    <i class="fas fa-exclamation-circle fa-2x"></i>
                                {% elif 'Low' in calculation_details.category and 'Very Low' not in calculation_details.category %}
                                    <i class="fas fa-info-circle fa-2x"></i>
                                {% else %}
                                    <i class="fas fa-check-circle fa-2x"></i>
                                {% endif %}
                            </div>
                            <div>
                                <h4 class="alert-heading mb-1">
                                    Bleeding Risk Level: 
                                    <span class="font-weight-bold text-uppercase">{{ calculation_details.category }}</span>
                                </h4>
                                <p class="mb-0">
                                    <strong>PRECISE-DAPT Score: {{ calculation_details.score }}</strong>
                                    {% if 'High' in calculation_details.category %}
                                        - <strong>Consider shorter DAPT duration (3-6 months)</strong>
                                    {% elif 'Moderate' in calculation_details.category %}
                                        - <strong>Standard DAPT duration with careful monitoring</strong>
                                    {% else %}
                                        - <strong>Standard DAPT duration (12 months) recommended</strong>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Left Column: Patient Demographics and Lab Values -->
                        <div class="col-lg-6 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-user-md mr-2"></i>Patient Data & PRECISE-DAPT Parameters
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr>
                                                <th class="w-40">Age:</th>
                                                <td>
                                                    <span class="badge badge-{% if calculation_details.score_details.age_score_component > 0 %}warning{% else %}secondary{% endif %}">
                                                        {{ calculation_details.age if calculation_details.age is not none else 'Unknown' }} years
                                                    </span>
                                                    {% if calculation_details.score_details.age_score_component > 0 %}
                                                        <small class="text-warning ml-2">
                                                            <i class="fas fa-plus-circle"></i> {{ calculation_details.score_details.age_score_component }} points
                                                        </small>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Gender:</th>
                                                <td>
                                                    <span class="badge badge-info">
                                                        {{ calculation_details.sex.title() if calculation_details.sex else 'Unknown' }}
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Hemoglobin (g/dL):</th>
                                                <td>
                                                    {% if calculation_details.hb_value is not none %}
                                                        <span class="badge badge-{% if calculation_details.score_details.hemoglobin_score_component > 0 %}warning{% else %}success{% endif %}">
                                                            {{ "%.1f" | format(calculation_details.hb_value) }}
                                                        </span>
                                                        {% if calculation_details.score_details.hemoglobin_score_component > 0 %}
                                                            <small class="text-warning ml-2">
                                                                <i class="fas fa-plus-circle"></i> {{ calculation_details.score_details.hemoglobin_score_component }} points
                                                            </small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="badge badge-secondary">Not measured</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Creatinine Clearance (mL/min/1.73m²):</th>
                                                <td>
                                                    {% if calculation_details.ccr_value is not none %}
                                                        <span class="badge badge-{% if calculation_details.score_details.creatinine_clearance_score_component > 0 %}warning{% else %}success{% endif %}">
                                                            {{ "%.0f" | format(calculation_details.ccr_value) }}
                                                        </span>
                                                        {% if calculation_details.score_details.creatinine_clearance_score_component > 0 %}
                                                            <small class="text-warning ml-2">
                                                                <i class="fas fa-plus-circle"></i> {{ calculation_details.score_details.creatinine_clearance_score_component }} points
                                                            </small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="badge badge-secondary">Not measured</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>White Blood Cell Count (×10⁹/L):</th>
                                                <td>
                                                    {% if calculation_details.wbc_value is not none %}
                                                        <span class="badge badge-{% if calculation_details.score_details.wbc_score_component > 0 %}warning{% else %}success{% endif %}">
                                                            {{ "%.1f" | format(calculation_details.wbc_value) }}
                                                        </span>
                                                        {% if calculation_details.score_details.wbc_score_component > 0 %}
                                                            <small class="text-warning ml-2">
                                                                <i class="fas fa-plus-circle"></i> {{ calculation_details.score_details.wbc_score_component }} points
                                                            </small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="badge badge-secondary">Not measured</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Prior Bleeding History:</th>
                                                <td>
                                                    <span class="badge badge-{% if calculation_details.bleeding_history %}danger{% else %}success{% endif %}">
                                                        {% if calculation_details.bleeding_history %}Yes{% else %}No{% endif %}
                                                    </span>
                                                    {% if calculation_details.score_details.bleeding_history_score_component > 0 %}
                                                        <small class="text-danger ml-2">
                                                            <i class="fas fa-plus-circle"></i> {{ calculation_details.score_details.bleeding_history_score_component }} points
                                                        </small>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: PRECISE-DAPT Score Summary -->
                        <div class="col-lg-6 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-calculator mr-2"></i>PRECISE-DAPT Score Summary
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr>
                                                <th class="w-60">Age Score:</th>
                                                <td class="text-right">
                                                    <span class="badge badge-{% if calculation_details.score_details.age_score_component > 0 %}warning{% else %}light{% endif %} badge-lg">
                                                        {{ calculation_details.score_details.age_score_component }} points
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Hemoglobin Score:</th>
                                                <td class="text-right">
                                                    <span class="badge badge-{% if calculation_details.score_details.hemoglobin_score_component > 0 %}warning{% else %}light{% endif %} badge-lg">
                                                        {{ calculation_details.score_details.hemoglobin_score_component }} points
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Creatinine Clearance Score:</th>
                                                <td class="text-right">
                                                    <span class="badge badge-{% if calculation_details.score_details.creatinine_clearance_score_component > 0 %}warning{% else %}light{% endif %} badge-lg">
                                                        {{ calculation_details.score_details.creatinine_clearance_score_component }} points
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>White Blood Cell Score:</th>
                                                <td class="text-right">
                                                    <span class="badge badge-{% if calculation_details.score_details.wbc_score_component > 0 %}warning{% else %}light{% endif %} badge-lg">
                                                        {{ calculation_details.score_details.wbc_score_component }} points
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Prior Bleeding Score:</th>
                                                <td class="text-right">
                                                    <span class="badge badge-{% if calculation_details.score_details.bleeding_history_score_component > 0 %}danger{% else %}light{% endif %} badge-lg">
                                                        {{ calculation_details.score_details.bleeding_history_score_component }} points
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr class="border-top">
                                                <th class="h5">Total Score:</th>
                                                <td class="text-right">
                                                    <span class="badge badge-{% if 'High' in calculation_details.category %}danger{% elif 'Moderate' in calculation_details.category %}warning{% else %}success{% endif %} badge-lg h5 mb-0">
                                                        {{ calculation_details.score }} points
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Risk Components Section -->
                    {% if risk_components %}
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-list-ul mr-2"></i>
                                    Detailed PRECISE-DAPT Components ({{ risk_components|length }})
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>Parameter</th>
                                                <th>Value</th>
                                                <th>Score</th>
                                                <th>Date</th>
                                                <th>Description</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for component in risk_components %}
                                                <tr class="{% if component.score > 0 %}table-warning{% endif %}">
                                                    <td>
                                                        <strong>{% if component.parameter == 'PreciseDAPT - Age' %}Age{% elif component.parameter == 'PreciseDAPT - Hemoglobin' %}Hemoglobin{% elif component.parameter == 'PreciseDAPT - Creatinine Clearance' %}Creatinine Clearance{% elif component.parameter == 'PreciseDAPT - White Blood Cell Count' %}White Blood Cell Count{% elif component.parameter == 'PreciseDAPT - Prior Bleeding' %}Prior Bleeding History{% else %}{{ component.parameter }}{% endif %}</strong>
                                                    </td>
                                                    <td>{{ component.value }}</td>
                                                    <td>
                                                        <span class="badge badge-{% if component.score >= 15 %}danger{% elif component.score >= 5 %}warning{% elif component.score > 0 %}info{% else %}secondary{% endif %}">
                                                            {{ component.score }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted">{{ component.date }}</small>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted">{{ component.description }}</small>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- High Risk Guideline Section -->
                    {% if 'High' in calculation_details.category %}
                        <div class="card shadow-sm mb-4 border-danger">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    High Bleeding Risk DAPT Management Guidelines
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning">
                                    <h6><i class="fas fa-info-circle mr-2"></i>Clinical Recommendations (PRECISE-DAPT ≥25):</h6>
                                    <ul class="mb-0">
                                        <li>Consider shorter DAPT duration (3-6 months)</li>
                                        <li>Close monitoring for bleeding events</li>
                                        <li>Evaluate use of proton pump inhibitors</li>
                                        <li>Regular hemoglobin and renal function checks</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% elif 'Moderate' in calculation_details.category %}
                        <div class="card shadow-sm mb-4 border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="fas fa-exclamation-circle mr-2"></i>
                                    Moderate Bleeding Risk DAPT Management
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle mr-2"></i>Clinical Recommendations (PRECISE-DAPT 16-24):</h6>
                                    <ul class="mb-0">
                                        <li>Standard DAPT duration (12 months)</li>
                                        <li>Regular monitoring of bleeding risk factors</li>
                                        <li>Consider individualized treatment strategy</li>
                                        <li>Consult cardiologist when necessary</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="card shadow-sm mb-4 border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    Low Bleeding Risk DAPT Management
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-success">
                                    <h6><i class="fas fa-check-circle mr-2"></i>Clinical Recommendations (PRECISE-DAPT 0-15):</h6>
                                    <ul class="mb-0">
                                        <li>Standard DAPT duration (12 months) recommended</li>
                                        <li>Routine monitoring sufficient</li>
                                        <li>Assess extended therapy based on ischemic risk</li>
                                        <li>Follow guideline-recommended antiplatelet therapy</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Technical Details (Collapsible) -->
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <button class="btn btn-link btn-block text-left" type="button" 
                                    data-toggle="collapse" data-target="#technicalDetails" 
                                    aria-expanded="false" aria-controls="technicalDetails">
                                <i class="fas fa-cogs mr-2"></i>
                                Technical Calculation Details
                                <i class="fas fa-chevron-down float-right"></i>
                            </button>
                        </div>
                        <div id="technicalDetails" class="collapse">
                            <div class="card-body">
                                <h6>Configuration Version: {{ config_version or '1.2.0' }}</h6>
                                <h6>Scoring System: PRECISE-DAPT 2017</h6>
                                
                                <h6 class="mt-4">Score Details:</h6>
                                <pre class="bg-light p-3" style="max-height: 300px; overflow-y: auto;">{{ calculation_details.score_details | tojson(indent=2) }}</pre>
                                
                                {% if risk_components %}
                                <h6 class="mt-4">Complete Component List:</h6>
                                <pre class="bg-light p-3" style="max-height: 300px; overflow-y: auto;">{{ risk_components | tojson(indent=2) }}</pre>
                                {% endif %}
                            </div>
                        </div>
                    </div>

    {% else %}
                    <!-- Error State -->
                    <div class="alert alert-danger shadow-sm" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fa-2x mr-3"></i>
                            <div>
                                <h4 class="alert-heading">Unable to Calculate or Display PRECISE-DAPT Score</h4>
                                <p class="mb-0">Please check if the data is complete or try again later.</p>
                            </div>
                        </div>
                    </div>
    {% endif %}

                <!-- Action Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <div>
                        <a href="{{ url_for('main_app_page') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Main App
                        </a>
                    </div>
                    <div>
                        <a href="{{ url_for('main_page') }}" class="btn btn-outline-info">
                            <i class="fas fa-tachometer-alt mr-2"></i>Simple Interface
                        </a>
                        <a href="{{ url_for('launch_cerner_sandbox') }}" class="btn btn-outline-primary ml-2">
                            <i class="fas fa-vial mr-2"></i>Cerner Sandbox Test
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
// Add some interactive features for PRECISE-DAPT
document.addEventListener('DOMContentLoaded', function() {
    // Highlight components with scores
    const scoredRows = document.querySelectorAll('tr.table-warning');
    scoredRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#fff3cd';
            this.style.transform = 'scale(1.02)';
            this.style.transition = 'all 0.2s';
        });
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
            this.style.transform = '';
        });
    });
    
    // Add tooltips for score ranges
    const scoreElements = document.querySelectorAll('.badge');
    scoreElements.forEach(badge => {
        if (badge.textContent.includes('分')) {
            badge.setAttribute('title', 'PRECISE-DAPT 評分系統: 0-100分');
        }
    });
});
</script>
{% endblock %}

<!-- Custom CSS for Enhanced PRECISE-DAPT Styling -->
<style>
    /* Enhanced styling for high bleeding risk alert */
    .alert-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
        border: 2px solid #bd2130 !important;
        color: white !important;
        font-weight: 500;
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3) !important;
    }
    
    .alert-danger .alert-heading {
        color: white !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    .alert-danger .fas {
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    /* Enhanced warning styling for moderate risk */
    .alert-warning {
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%) !important;
        border: 2px solid #d39e00 !important;
        color: #212529 !important;
        font-weight: 500;
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3) !important;
    }
    
    /* Enhanced info styling for low risk */
    .alert-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
        border: 2px solid #117a8b !important;
        color: white !important;
        font-weight: 500;
        box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3) !important;
    }
    
    .alert-info .alert-heading {
        color: white !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    /* Enhanced success styling for very low risk */
    .alert-success {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%) !important;
        border: 2px solid #1c7430 !important;
        color: white !important;
        font-weight: 500;
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3) !important;
    }
    
    .alert-success .alert-heading {
        color: white !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    /* Badge styling enhancements */
    .badge-lg {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }
    
    .badge-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }
    
    .badge-warning {
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%) !important;
        box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
    }
    
    .badge-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
        box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
    }
    
    .badge-success {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%) !important;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }
    
    /* Table enhancements */
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .table-warning {
        background-color: #fff3cd !important;
    }
    
    /* PRECISE-DAPT specific styling */
    .card-header.bg-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
    }
    
    .card-header.bg-success {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%) !important;
    }
    
    .card-header.bg-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
    }
</style>
