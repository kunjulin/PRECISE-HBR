{% extends "layout.html" %}

{% block title %}Test Patients - Development Mode{% endblock %}

{% block content %}
<style>
    .test-warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 2rem;
    }
    .patient-card {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.2s;
    }
    .patient-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
        border-color: #0d6efd;
    }
    .direct-input-card {
        background: linear-gradient(135deg, #f8fff9 0%, #e8f5e9 100%);
        border: 2px solid #28a745;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.15);
    }
    .direct-input-card:hover {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.25);
    }
    .patient-id-input {
        font-family: 'Courier New', monospace;
        font-weight: 500;
    }
</style>

<div class="container mt-4">
    <div class="test-warning">
        <h5>âš ï¸ é–‹ç™¼/æ¸¬è©¦æ¨¡å¼</h5>
        <p class="mb-0">
            æ­¤é é¢åƒ…ä¾›é–‹ç™¼å’Œæ¸¬è©¦ä½¿ç”¨ã€‚é€™äº›æ˜¯å¾ FHIR æœå‹™å™¨å¯¦æ™‚ç²å–çš„æ‚£è€…æ•¸æ“šã€‚
            <strong>è«‹å‹¿åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚</strong>
        </p>
    </div>

    <h2 class="mb-4">æ¸¬è©¦æ‚£è€…åˆ—è¡¨</h2>
    
    <!-- Server Selection -->
    <div class="card mb-4">
        <div class="card-body">
            <h6 class="card-title">é¸æ“‡ FHIR æœå‹™å™¨</h6>
            
            <!-- Preset Server Buttons -->
            <div class="mb-3">
                <div class="btn-group flex-wrap" role="group">
                    <a href="?server=https://launch.smarthealthit.org/v/r4/fhir" class="btn btn-sm btn-outline-primary">
                        SMART Health IT
                    </a>
                    <a href="?server=https://r4.smarthealthit.org" class="btn btn-sm btn-outline-primary">
                        Logica Sandbox
                    </a>
                    <a href="?server=https://hapi.fhir.org/baseR4" class="btn btn-sm btn-outline-primary">
                        HAPI FHIR
                    </a>
                </div>
                <small class="text-muted d-block mt-2">âš¡ é»æ“Šå¿«é€Ÿåˆ‡æ›æœå‹™å™¨</small>
            </div>
            
            <!-- Custom Server Input -->
            <form method="GET" class="row g-3">
                <div class="col-md-9">
                    <input type="url" class="form-control" name="server" 
                           value="{{ fhir_server }}" 
                           placeholder="https://launch.smarthealthit.org/v/r4/fhir">
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">è¼‰å…¥æ‚£è€…</button>
                </div>
            </form>
            <small class="text-muted">
                ç•¶å‰æœå‹™å™¨: <code>{{ fhir_server }}</code>
            </small>
        </div>
    </div>

    <!-- Direct Patient ID Input -->
    <div class="card mb-4 direct-input-card">
        <div class="card-body">
            <h6 class="card-title text-success mb-2">
                ğŸ” ç›´æ¥è¼¸å…¥ Patient ID
            </h6>
            <p class="text-muted small mb-3">
                å¦‚æœæ‚¨çŸ¥é“æ‚£è€…çš„ IDï¼Œå¯ä»¥ç›´æ¥è¼¸å…¥ä»¥å¿«é€Ÿè¼‰å…¥è©²æ‚£è€…çš„æ•¸æ“š
            </p>
            
            <form method="GET" action="{{ url_for('views.test_mode') }}" class="row g-3" id="patientIdForm">
                <input type="hidden" name="server" value="{{ fhir_server }}">
                <div class="col-md-9">
                    <div class="input-group">
                        <span class="input-group-text">Patient ID</span>
                        <input type="text" 
                               class="form-control patient-id-input" 
                               name="patient_id" 
                               id="patientIdInput"
                               placeholder="ä¾‹å¦‚: smart-1288992, 47051312"
                               required>
                    </div>
                    <small class="text-muted">
                        å°‡ä½¿ç”¨ç•¶å‰æœå‹™å™¨: <code>{{ fhir_server }}</code>
                    </small>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-success w-100">
                        ğŸš€ è¼‰å…¥æ‚£è€…
                    </button>
                </div>
            </form>
            
            <!-- Quick Patient ID Examples -->
            <div class="mt-3 pt-2 border-top">
                <small class="text-muted d-block mb-2"><strong>å¸¸ç”¨æ¸¬è©¦ Patient ID:</strong></small>
                <div class="d-flex flex-wrap gap-2">
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="fillPatientId('smart-1288992')">
                        smart-1288992
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="fillPatientId('smart-1482713')">
                        smart-1482713
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="fillPatientId('smart-1551992')">
                        smart-1551992
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function fillPatientId(patientId) {
            document.getElementById('patientIdInput').value = patientId;
            document.getElementById('patientIdInput').focus();
        }
        
        // Remember last used patient ID
        document.getElementById('patientIdForm').addEventListener('submit', function() {
            const patientId = document.getElementById('patientIdInput').value;
            localStorage.setItem('lastPatientId', patientId);
        });
        
        // Restore last used patient ID on page load
        window.addEventListener('load', function() {
            const lastPatientId = localStorage.getItem('lastPatientId');
            if (lastPatientId) {
                document.getElementById('patientIdInput').value = lastPatientId;
            }
        });
    </script>

    {% if error %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <strong>âš ï¸ è­¦å‘Šï¼š</strong> {{ error }}
        <br><small>é¡¯ç¤ºé»˜èªçš„å‚™ç”¨æ¸¬è©¦æ‚£è€…ã€‚</small>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <p class="text-muted mb-4">
        é¸æ“‡ä¸€å€‹æ¸¬è©¦æ‚£è€…ä¾†ç›´æ¥æ¸¬è©¦æ‡‰ç”¨åŠŸèƒ½ï¼ˆç„¡éœ€ OAuth æˆæ¬Šï¼‰<br>
        <small>å…±æ‰¾åˆ° <strong>{{ patients|length }}</strong> ä½æ‚£è€…</small>
    </p>

    <div class="row">
        {% for patient in patients %}
        <div class="col-md-6 mb-3">
            <div class="patient-card">
                <h5>{{ patient.name }}</h5>
                <p class="text-muted mb-2">
                    <strong>Patient ID:</strong> <code>{{ patient.id }}</code><br>
                    <strong>Gender:</strong> {{ patient.gender }}<br>
                    <strong>Birth Date:</strong> {{ patient.birthDate }}<br>
                    <small>{{ patient.description }}</small>
                </p>
                <a href="{{ url_for('views.test_mode') }}?patient_id={{ patient.id }}&server={{ fhir_server }}" 
                   class="btn btn-primary">
                    ä½¿ç”¨æ­¤æ‚£è€…æ¸¬è©¦
                </a>
            </div>
        </div>
        {% endfor %}
    </div>

    <hr class="my-4">

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">å…¶ä»–æ¸¬è©¦é¸é …</h5>
            <div class="list-group list-group-flush">
                <a href="{{ url_for('views.test_mode') }}" class="list-group-item list-group-item-action">
                    <strong>å¿«é€Ÿæ¸¬è©¦æ¨¡å¼</strong><br>
                    <small>ä½¿ç”¨é»˜èªæ¸¬è©¦æ‚£è€… (Amy V. Shaw) ç›´æ¥é€²å…¥ä¸»æ‡‰ç”¨</small>
                </a>
                <a href="/standalone" class="list-group-item list-group-item-action">
                    <strong>Standalone Launchï¼ˆå®Œæ•´ OAuthï¼‰</strong><br>
                    <small>ä½¿ç”¨å®Œæ•´çš„ SMART on FHIR æˆæ¬Šæµç¨‹</small>
                </a>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <h6>æŠ€è¡“èªªæ˜</h6>
        <ul class="small text-muted">
            <li><strong>ç›´æ¥è¼¸å…¥ Patient ID:</strong> å¦‚æœæ‚¨çŸ¥é“ç‰¹å®šæ‚£è€…çš„ IDï¼Œå¯ä»¥ç›´æ¥è¼¸å…¥ä»¥å¿«é€Ÿè¼‰å…¥æ•¸æ“šï¼Œç„¡éœ€å¾åˆ—è¡¨ä¸­é¸æ“‡</li>
            <li><strong>æ‚£è€…åˆ—è¡¨:</strong> å¾ç•¶å‰ FHIR æœå‹™å™¨å¯¦æ™‚ç²å–æœ€å¤š 20 ä½æ‚£è€…</li>
            <li><strong>æ”¯æŒçš„æœå‹™å™¨:</strong> SMART Health ITã€Logica Sandboxã€HAPI FHIR æˆ–ä»»ä½•å…¬é–‹çš„ FHIR R4 æœå‹™å™¨</li>
            <li><strong>æ¸¬è©¦æ¨¡å¼:</strong> æœƒå‰µå»ºä¸€å€‹æ¨¡æ“¬ sessionï¼ˆtoken: <code>test-mode-no-auth</code>ï¼‰ï¼Œç„¡éœ€å¯¦éš›çš„ OAuth token</li>
            <li><strong>è¨˜æ†¶åŠŸèƒ½:</strong> ä¸Šæ¬¡ä½¿ç”¨çš„ Patient ID æœƒè‡ªå‹•ä¿å­˜åˆ°ç€è¦½å™¨æœ¬åœ°å­˜å„²</li>
            <li><strong>å®‰å…¨æç¤º:</strong> åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œè«‹å‹™å¿…ç¦ç”¨æ­¤åŠŸèƒ½æˆ–æ·»åŠ é©ç•¶çš„è¨ªå•æ§åˆ¶</li>
        </ul>
    </div>
</div>
{% endblock %}

